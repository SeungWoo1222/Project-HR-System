<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/web/thymeleaf/layout"
      layout:decorate="~{fragments/layout :: layout(title='보고서 수정')}">

<th:block layout:fragment="css">
    <link rel="stylesheet" th:href="@{/css/layout.css}">
</th:block>

<th:block layout:fragment="script">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script th:src="@{/js/report.js}"></script>
    <script th:src="@{/js/report-file.js}"></script>
    <script>
        $(document).ready(function () {
            initializeRegisteredFiles(); // 기존에 있는 파일을 IdList에 추가

            $('#editButton').on('click', function () {
                $('#departmentIdContainer').show();
                $('#editButton').hide();

                initEventListeners(); //  부서 선택, 임원 전체선택 메소드 정의
            });

            $('#editFileButton').on('click', function () {
                $('#file-area').show();
                $('#fileList').hide();
                $('#editFileButton').hide();

                // 기존 파일을 업로드 목록으로 복사
                registeredFileIdList.forEach(fileId => {
                    const fileElement = document.querySelector(`input[value="${fileId}"]`);
                    const fileName = fileElement.closest('li').querySelector('button[type="submit"]').innerText;

                    // 기존 파일을 filesArr에 추가
                    filesArr.push({
                        name: fileName,
                        id: fileId, // ID를 추가하여 기존 파일임을 표시
                        is_delete: false
                    });

                    // 업로드 목록에 추가
                    let htmlData = '';
                    htmlData += '<div id="file' + fileNo + '" class="filebox">';
                    htmlData += '   <p class="name">' + fileName + '</p>';
                    htmlData += '   <a class="delete" onclick="deleteFile(' + fileNo + ');"><img src="/images/icons/delete.png" class="delete-btn" alt="delete-btn" width="20"/></a>';
                    htmlData += '</div>';
                    document.querySelector('.file-list').insertAdjacentHTML('beforeend', htmlData);
                    fileNo++;
                });

            });
        });

        function deleteReportFile(num) {
            // 'filesArr' 배열에서 해당 파일 객체의 'is_delete' 속성 설정
            filesArr[num].is_delete = true;

            // 파일 ID가 있으면 registeredFileIdList에서 제거
            if (filesArr[num].id) {
                const index = registeredFileIdList.indexOf(filesArr[num].id);
                if (index > -1) {
                    registeredFileIdList.splice(index, 1);
                }
            }

            // UI에서 파일을 삭제
            document.querySelector("#file" + num).remove();
        }

        function updateReportForm(event) {
            // 유효성 검사 실행
            if (!validateReportForm(event)) { return; }

            // form 제출 처리
            const { form, actionUrl } = handleReportForm(event);
            const formData = new FormData();

            // FormData 객체에 employee 필드를 추가
            const idList = Object.keys(selectedEmployees).length === 0
                ? [document.getElementById('currentApproverId').value]
                : Object.keys(selectedEmployees);

            const nameList = Object.keys(selectedEmployees).length === 0
                ? [document.getElementById('currentApproverName').value]
                : Object.values(selectedEmployees);

            console.log("reportId", document.getElementById('reportId').value);
            console.log("writerId", document.getElementById('writerId').value);
            console.log("title", document.getElementById('title').value);
            console.log("content", document.getElementById('content').value);
            console.log("completeDate", document.getElementById('completeDate').value);



            const report = {
                reportId: document.getElementById('reportId').value,
                writerId: document.getElementById('writerId').value,
                title: document.getElementById('title').value,
                content: document.getElementById('content').value,
                idList: idList,
                nameList: nameList,
                completeDate: document.getElementById('completeDate').value
            };
            formData.append("report", new Blob([JSON.stringify(report)], { type: "application/json" }));

            // filesArr에 저장된 파일들을 FormData에 추가
            filesArr.forEach((file) => {
                if (!file.is_delete) { // 삭제된 파일 제외
                    if (file.id) {
                        // 기존 파일의 경우
                        formData.append('registeredFileIdList', file.id);
                    } else {
                        // 새로 추가된 파일의 경우
                        formData.append('reportFiles', file);
                    }
                }
            });

            // 사용자가 파일 수정 버튼을 누르지 않은 경우, 기존 파일 전송
            if (filesArr.length === 0 && registeredFileIdList && registeredFileIdList.length > 0) {
                registeredFileIdList.forEach((fileId, index) => {
                    formData.append('registeredFileIdList', fileId);
                });
            }

            // FormData 객체를 반복하여 key와 value를 출력
            formData.forEach((value, key) => {
                if (value instanceof Blob) {
                    // Blob 객체의 내용을 출력
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        console.log(`${key}: ${e.target.result}`); // Blob의 내용을 출력
                    };
                    reader.readAsText(value); // Blob을 텍스트로 읽음
                } else {
                    console.log(`${key}: ${value}`);
                }
            });

            // 데이터를 서버로 전송
            fetch(actionUrl, {
                method: 'POST',
                body: formData
            })
                .then(response => response.text().then(data => ({
                    status: response.status,
                    text: data
                })))
                .then(response => {
                    console.log('서버 응답 데이터 :', response.text);
                    if (response.status === 200) {
                        alert(response.text); // 성공 메시지 알림
                        window.location.href = '/report/list';
                    } else if (response.status === 404) {
                        alert(response.text); // 404 오류 메세지 알림
                        window.location.reload();
                    } else if (response.status === 400) {
                        alert(response.text); // 400 오류 메시지 알림
                    } else if (response.status === 500) {
                        alert(response.text); // 500 오류 메시지 알림
                    } else {
                        alert('보고서 수정 중 오류가 발생하였습니다.\n재등록 시도 후 여전히 문제가 발생하면 관리자에게 문의해주세요');
                        window.location.reload();
                    }
                })
                .catch(error => {
                    console.error('Error :', error.message);
                    alert('오류가 발생하였습니다.\n관리자에게 문의해주세요.');
                });
        }
    </script>
</th:block>

<div layout:fragment="~{content}">
    <div class="content">

        <!-- 테스트용 reportId와 fileId 표시 -->
        <h1>Report ID: <span th:text="${report.reportId}"></span></h1>
        <h1>File IDs:</h1>
        <ul>
            <li th:each="file : ${files}">
                <h1 th:text="${file.fileId}"></h1>
            </li>
        </ul>

        <h1>보고서 수정</h1>
        <form id="form" th:action="@{/report/edit}" method="post" enctype="multipart/form-data" onsubmit="return false">
            <input id="reportId" type="hidden" th:value="${report.reportId}">
            <input id="writerId" type="hidden" th:value="${report.writerId}">

            <div>
                <label for="title">제목:</label>
                <input id="title" type="text" name="title" th:value="${report.title}">
            </div>

            <div>
                <label for="content">내용:</label>
                <textarea id="content" th:text="${report.content}"></textarea>
            </div>
            <div>
                <label id="currentLabel" for="idContainer">현재 보고서 결재자 : </label>
                <span id="current" th:text="${report.approverName}"></span>
                <input type="hidden" id="currentApproverName" th:value="${report.approverName}"/>
                <input type="hidden" id="currentApproverId" th:value="${report.approverId}"/>
                <button type="button" id="editButton">결재자 수정</button>
            </div>

            <div id="departmentIdContainer" style="display: none;">
                <label for="departmentId">부서 선택:</label>
                <select id="departmentId" name="departmentId" onchange="loadEmployeesByDepartment()">
                    <option value="" disabled selected>부서를 선택하세요</option>
                    <option value="PR">생산(PR)</option>
                    <option value="QC">품질 관리(QC)</option>
                    <option value="SA">영업(SA)</option>
                    <option value="MK">마케팅(MK)</option>
                    <option value="FI">재무(FI)</option>
                    <option value="HR">인사(HR)</option>
                    <option value="RD">연구개발(RD)</option>
                </select>
            </div>

        <div id="employeeSection" style="display:none;">
            <div id="selectAllContainer">
                <label for="idContainer">임원 리스트</label>
                <button id="selectAllEmployeesButton" type="button">전체 선택</button>
            </div>

            <div id="idContainer">
                <!-- 직원 목록이 여기에 추가됩니다. -->
            </div>

            <div>
                <label id="selectedEmployeesLabel">선택된 결재자</label>
                <button id="deselectAllEmployeesButton" type="button">전체 해제</button>
                <div id="selectedEmployees" class="selected-employees"></div>
            </div>
        </div>

            <div>
                <label for="completeDate">업무 처리 날짜:</label>
                <input type="date" id="completeDate" th:value="${report.completeDate}">
            </div>
            <!-- 첨부 파일 리스트 표시 -->
            <button type="button" id="editFileButton">파일 수정</button>
            <div th:if="${files != null}">
            <span>첨부 파일</span>
                <ul id="fileList">
                    <li th:each="file : ${files}">
                        <form th:action="@{'/report/downloadFile'}" method="get">
                            <input type="hidden" class="editFileId" th:value="${file.fileId}"/>

                            <button type="submit" th:text="${file.originalFileName}">다운로드</button>
                            <button type="button" class="deleteRegisteredFileButton" th:fileId="${file.fileId}"
                                    onclick="deleteRegisteredFile(this, this.getAttribute('fileId'))">X</button>

                            <p style="font-size: 10px; color: gray;">
                                업로드 날짜: <span th:text="${file.uploadDate}" class="dateTime"></span>
                                파일 크기: <span th:text="${file.fileSize / 1024} + ' KB'"></span>
                            </p>
                        </form>
                    </li>
                </ul>
            </div>

            <div id="file-area" style="display: none;">
                    <p>문서는 최대 3개, 각 10MB 이하까지 업로드 가능합니다.</p>
                    <label for="reportDocuments" class="input-file-btn">문서 업로드</label>
                    <input type="file" id="reportDocuments" class="hidden"
                           onchange="addFile(this)"
                           multiple/>
                    <div class="file-list"></div>
                </div>
            <div id="error-alert"></div>
            <button type="button" onclick="updateReportForm(event)">보고서 수정</button>
        </form>
    </div>
</div>
</html>
