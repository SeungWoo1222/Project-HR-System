<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/web/thymeleaf/layout"
      layout:decorate="~{fragments/layout :: layout(title='보고서 수정')}">

<th:block layout:fragment="css">
    <link rel="stylesheet" th:href="@{/css/layout.css}">
</th:block>

<th:block layout:fragment="script">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script th:src="@{/js/report.js}"></script>
    <script th:src="@{/js/report-file.js}"></script>
    <script>
        $(document).ready(function () {
            initializeRegisteredFiles(); // 기존에 있는 파일을 IdList에 추가

            $('#editButton').on('click', function () {
                $('#departmentIdContainer').show();

                initEventListeners(); //  부서 선택, 임원 전체선택 메소드 정의
            });

            $('#editFileButton').on('click', function () {
                $('#file-area').show();
                $('#fileList').hide();
            });

        });
    </script>
</th:block>

<div layout:fragment="~{content}">
    <div class="content">
        <h1>보고서 수정</h1>
        <form id="form" method="post" enctype="multipart/form-data" onsubmit="return false">
            <input type="hidden" name="reportId" th:value="${report.reportId}">
            <input type="hidden" name="writerId" th:value="${report.writerId}">

            <div>
                <label for="title">제목:</label>
                <input type="text" id="title" name="title" th:value="${report.title}">
            </div>

            <div>
                <label for="content">내용:</label>
                <textarea id="content" name="content" th:text="${report.content}"></textarea>
            </div>
            <div>
                <label id="currentLabel" for="idContainer">현재 보고서 결재자 : </label>
                <span id="current" th:text="${report.approverName}"></span>
                <input type="hidden" id="currentApproverName" th:value="${report.approverName}"/>
                <input type="hidden" id="currentApproverId" th:value="${report.approverId}"/>
                <button type="button" id="editButton">결재자 수정</button>
            </div>

            <div id="departmentIdContainer" style="display: none;">
                <label for="departmentId">부서 선택:</label>
                <select id="departmentId" name="departmentId" onchange="loadEmployeesByDepartment()">
                    <option value="" disabled selected>부서를 선택하세요</option>
                    <option value="PR">생산(PR)</option>
                    <option value="QC">품질 관리(QC)</option>
                    <option value="SA">영업(SA)</option>
                    <option value="MK">마케팅(MK)</option>
                    <option value="FI">재무(FI)</option>
                    <option value="HR">인사(HR)</option>
                    <option value="RD">연구개발(RD)</option>
                </select>
            </div>

        <div id="employeeSection" style="display:none;">
            <div id="selectAllContainer">
                <label for="idContainer">임원 리스트</label>
                <button id="selectAllEmployeesButton" type="button">전체 선택</button>
            </div>

            <div id="idContainer">
                <!-- 직원 목록이 여기에 추가됩니다. -->
            </div>

            <div>
                <label id="selectedEmployeesLabel">선택된 결재자</label>
                <button id="deselectAllEmployeesButton" type="button">전체 해제</button>
                <div id="selectedEmployees" class="selected-employees"></div>
            </div>
        </div>

            <div>
                <label for="completeDate">업무 처리 날짜:</label>
                <input type="date" id="completeDate" name="completeDate" th:value="${report.completeDate}">
            </div>
            <!-- 첨부 파일 리스트 표시 -->
            <button type="button" id="editFileButton">파일 수정</button>
            <div th:if="${files != null}">
            <span>첨부 파일</span>
                <ul id="fileList">
                    <li th:each="file : ${files}">
                        <form th:action="@{'/report/downloadFile'}" method="get">
                            <input type="hidden" class="editFileId" th:value="${file.fileId}"/>

                            <button type="submit" th:text="${file.originalFileName}">다운로드</button>
                            <button type="button" class="deleteRegisteredFileButton" th:fileId="${file.fileId}"
                                    onclick="deleteRegisteredFile(this, this.getAttribute('fileId'))">X</button>

                            <p style="font-size: 10px; color: gray;">
                                업로드 날짜: <span th:text="${file.uploadDate}" class="dateTime"></span>
                                파일 크기: <span th:text="${file.fileSize / 1024} + ' KB'"></span>
                            </p>
                        </form>
                    </li>
                </ul>
            </div>

            <div id="file-area" style="display: none;">
                    <p>문서는 최대 3개, 각 10MB 이하까지 업로드 가능합니다.</p>
                    <label for="reportDocuments" class="input-file-btn">문서 업로드</label>
<!--                    <input type="file" id="reportDocuments" class="hidden" name="reportDocuments"-->
                    <input type="file" id="reportDocuments" class="hidden"
                           onchange="addFile(this)"
                           multiple/>
                    <div class="file-list"></div>
                </div>

            <button type="button" onclick="submitUpdatedFiles(event, '/report/edit')">보고서 수정</button>
        </form>
    </div>
</div>
</html>
