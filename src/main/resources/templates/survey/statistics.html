<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/web/thymeleaf/layout"
      layout:decorate="~{fragments/layout-with-modal :: layout(title='설문조사')}" >

<th:block layout:fragment="css">
  <link th:href="@{/css/pagination.css}" rel="stylesheet">
  <link th:href="@{/css/survey/detail.css}" rel="stylesheet" />
</th:block>

<th:block layout:fragment="script">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</th:block>

<div layout:fragment="~{content}">
  <div class="content">
    <div class="survey-container" th:if="${#authentication.principal.getUsername} == ${createdBy}">
      <div class="content-header">
        <div class="content-header-left"></div>
        <div class="content-header-center">
          <a class="" th:href="@{'/survey/' + ${survey.id}}">설문</a>
          <a class="" th:href="@{'/survey/participants?surveyId=' + ${survey.id}}">응답</a>
          <a class="active" th:href="@{'/survey/statistics?surveyId=' + ${survey.id}}">통계</a>
          <a class="" th:href="@{'/survey/list'}">설문 목록</a>
        </div>
        <div class="content-header-right"></div>
      </div>
      <div>
        <h2 th:text="${survey.title}">설문 제목</h2>
        <p th:text="${survey.description}">설문 설명</p>
        <p>설문기간 : <span th:text="${#temporals.format(survey.createdAt, 'yyyy-MM-dd')}"></span> ~
          <span th:text="${#temporals.format(survey.expiresAt, 'yyyy-MM-dd')}"></span></p>
        <p>설문 작성자 : <span th:text="${survey.createdBy}"></span></p>

        <div>
          <h2>설문 통계 <span th:text="'총 ' + ${participants} + '개'" style="font-size: 18px"/></h2>
          <div th:each="question, stat : ${survey.questions}">
            <div class="question">
              <p><span th:text="${(stat.index + 1) + '번'}"></span>. <span th:text="${question.questionText}">질문 텍스트</span></p>
              <div th:if="${question.questionType == 'radio' or question.questionType == 'checkbox'}">
                <canvas th:attr="id='chart_' + ${question.id}" width="400" height="300"></canvas>
                <script th:inline="javascript">
                  var responseMap = [[${question.statistics?.responseCounts}]];

                  var keyArr = Object.keys(responseMap);
                  var valueArr = Object.values(responseMap);

                  // 차트를 그릴 컨텍스트 가져오기
                  var ctx = document.getElementById('chart_' + [[${question.id}]]).getContext('2d');

                  // 차트 생성
                  var chart = new Chart(ctx, {
                    type: 'pie',  // 원형 차트
                    data: {
                      labels: keyArr,  // 옵션 이름
                      datasets: [{
                        label: '응답 수',
                        data: valueArr,  // 각 옵션에 대한 응답 수
                        backgroundColor: [
                          'rgba(255, 99, 132, 0.2)',
                          'rgba(54, 162, 235, 0.2)',
                          'rgba(255, 206, 86, 0.2)',
                          'rgba(75, 192, 192, 0.2)',
                          'rgba(153, 102, 255, 0.2)',
                          'rgba(255, 159, 64, 0.2)'
                        ],
                        borderColor: [
                          'rgba(255, 99, 132, 1)',
                          'rgba(54, 162, 235, 1)',
                          'rgba(255, 206, 86, 1)',
                          'rgba(75, 192, 192, 1)',
                          'rgba(153, 102, 255, 1)',
                          'rgba(255, 159, 64, 1)'
                        ],
                        borderWidth: 1
                      }]
                    },
                    options: {
                      responsive: false,
                      plugins: {
                        legend: {
                          position: 'top'
                        },
                        tooltip: {
                          enabled: true
                        }
                      }
                    }
                  });
                </script>
              </div>
              <div th:unless="${question.questionType == 'radio' or question.questionType == 'checkbox'}">
                  응애!
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
</html>
